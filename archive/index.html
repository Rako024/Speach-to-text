<!DOCTYPE html>
<html lang="az">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>TV Arxiv · Axtar & Klip</title>
    <style>
        :root {
            --bg: #0b1020;
            --panel: #11182c;
            --card: #0f1530;
            --muted: #8ea0c0;
            --text: #eaf0ff;
            --accent: #4c7dff;
            --radius: 14px;
            --shadow: 0 12px 30px rgba(0, 0, 0, .35)
        }

        * {
            box-sizing: border-box
        }

        html,
        body {
            height: 100%
        }

        body {
            margin: 0;
            font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
            background:
                radial-gradient(1000px 600px at 20% -10%, #182246 0%, transparent 60%),
                radial-gradient(900px 500px at 120% 10%, #0f1a3d 0%, transparent 55%), var(--bg);
            color: var(--text)
        }

        .wrap {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px
        }

        header {
            position: sticky;
            top: 0;
            z-index: 10;
            background: linear-gradient(180deg, rgba(11, 16, 32, .9), rgba(11, 16, 32, .55) 60%, transparent);
            backdrop-filter: blur(8px)
        }

        .toolbar {
            display: grid;
            gap: 12px;
            grid-template-columns: 1fr auto auto;
            align-items: center;
            padding: 12px 0 10px
        }

        .brand {
            font-weight: 700;
            letter-spacing: .2px;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px
        }

        .brand .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--accent);
            box-shadow: 0 0 20px var(--accent)
        }

        .panel {
            background: linear-gradient(180deg, #121a34, #0f1630);
            border: 1px solid #1a2446;
            border-radius: var(--radius);
            padding: 14px;
            box-shadow: var(--shadow)
        }

        .token-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap
        }

        .token-row input {
            flex: 1;
            min-width: 320px;
            padding: 12px 14px;
            border-radius: 12px;
            border: 1px solid #25325f;
            background: #0c1230;
            color: var(--text);
            outline: none
        }

        .btn {
            background: linear-gradient(180deg, #567cff, #3f66f8);
            border: none;
            color: #fff;
            padding: 12px 16px;
            border-radius: 12px;
            cursor: pointer;
            box-shadow: 0 10px 22px rgba(76, 125, 255, .25);
            font-weight: 600
        }

        .btn[disabled] {
            opacity: .6;
            cursor: not-allowed
        }

        .btn.secondary {
            background: #182145;
            box-shadow: none;
            border: 1px solid #263264
        }

        .controls {
            margin-top: 14px;
            display: grid;
            grid-template-columns: 1.4fr .8fr auto;
            gap: 10px
        }

        .controls input,
        .controls select {
            padding: 12px 14px;
            border-radius: 12px;
            border: 1px solid #25325f;
            background: #0c1230;
            color: var(--text);
            outline: none
        }

        h2 {
            margin: 22px 0 12px;
            font-size: 18px;
            color: var(--muted);
            font-weight: 600;
            letter-spacing: .2px
        }

        #summary {
            min-height: 64px;
            white-space: pre-wrap
        }

        .cards {
            display: grid;
            gap: 12px;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr))
        }

        .card {
            background: linear-gradient(180deg, #121a34, #0e142b);
            border: 1px solid #1a2446;
            border-radius: 14px;
            padding: 14px;
            display: flex;
            flex-direction: column;
            gap: 10px
        }

        .meta {
            display: flex;
            gap: 8px;
            align-items: center;
            color: var(--muted);
            font-size: 12px;
            flex-wrap: wrap
        }

        .pill {
            padding: 4px 8px;
            border-radius: 999px;
            background: #141d42;
            border: 1px solid #27366e;
            color: #bcd1ff;
            font-weight: 600
        }

        .card p {
            margin: 4px 0 6px;
            line-height: 1.35
        }

        .card .actions {
            display: flex;
            gap: 8px;
            margin-top: auto
        }

        .card .actions .btn {
            padding: 10px 12px
        }

        .video-wrap {
            position: relative;
            background: linear-gradient(180deg, #111734, #0d1330);
            border: 1px solid #1a2446;
            border-radius: 16px;
            padding: 12px
        }

        .v-overlay {
            position: absolute;
            inset: 12px;
            border-radius: 12px;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, .25)
        }

        .v-overlay.show {
            display: flex
        }

        .spinner {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            border: 2px solid #30407a;
            border-top-color: transparent;
            display: inline-block;
            animation: s .8s linear infinite
        }

        @keyframes s {
            to {
                transform: rotate(360deg)
            }
        }

        video {
            width: 100%;
            max-height: 60vh;
            border-radius: 12px;
            background: #000
        }

        .empty {
            text-align: center;
            padding: 28px;
            color: var(--muted);
            border: 1px dashed #263264;
            border-radius: 14px;
            background: #0d1430
        }

        .row {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap
        }

        .muted {
            color: var(--muted)
        }

        .toast {
            position: fixed;
            right: 16px;
            bottom: 16px;
            background: #121a34;
            border: 1px solid #2a3a72;
            color: var(--text);
            padding: 12px 14px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            display: none
        }

        .toast.show {
            display: block;
            animation: fade 180ms ease-out
        }

        .toast.err {
            border-color: #6b2430;
            background: #1a0e14;
            color: #ffd7dc
        }

        @keyframes fade {
            from {
                opacity: .4;
                transform: translateY(4px)
            }

            to {
                opacity: 1;
                transform: none
            }
        }

        @media (max-width:720px) {
            .controls {
                grid-template-columns: 1fr
            }
        }
    </style>
</head>

<body>
    <header>
        <div class="wrap">
            <div class="toolbar">
                <div class="brand"><span class="dot"></span> TV Arxiv • Axtar & Klip</div>
                <div class="row muted" id="statusRow"></div>
                <div class="row"><button class="btn secondary" id="clearToken">Təmizlə</button></div>
            </div>
        </div>
    </header>

    <main class="wrap">
        <section class="panel">
            <div class="token-row">
                <input id="token" placeholder="Bearer JWT token (və ya STATIC_TOKEN) — yapışdırın" />
                <button class="btn" id="saveToken">Tokeni yadda saxla</button>
            </div>

            <div class="controls">
                <input id="kw" placeholder="Keyword (məs: pasha bank)" />
                <select id="channel">
                    <option value="">— Bütün kanallar —</option>
                    <option value="aztv">AZTV</option>
                    <option value="atv">ATV</option>
                    <option value="itv">ITV</option>
                    <option value="alvinchannel">ALVIN</option>
                    <option value="apatv">APA TV</option>
                </select>
                <button class="btn" id="btn"><span id="btnText">Axtar</span> <span id="btnSpin" class="spinner"
                        style="display:none"></span></button>
            </div>
        </section>

        <section>
            <h2>DeepSeek Qısa Xülasə</h2>
            <div class="panel" id="summary">Burada seçilmiş seqmentin ±15s konteksti üzrə xülasə görünəcək</div>
        </section>

        <section>
            <h2>Tapılan seqmentlər</h2>
            <div id="results" class="cards"></div>
            <div id="empty" class="empty" style="display:none">Nəticə tapılmadı</div>
        </section>

        <section>
            <h2>Seçilmiş klip</h2>
            <div class="video-wrap">
                <div class="v-overlay" id="vOverlay"><span class="spinner"></span></div>
                <video id="player" controls playsinline preload="metadata" controlslist="nodownload"></video>
            </div>
        </section>
    </main>

    <div id="toast" class="toast"></div>

    <script>
        // ---------- CONST ----------
        const MIN_CLIP_SEC = 30; // min 30s

        // ---------- Helpers ----------
        const $ = (s) => document.querySelector(s);
        const tokenInput = $("#token"), saveBtn = $("#saveToken"), clearBtn = $("#clearToken");
        const btn = $("#btn"), btnText = $("#btnText"), btnSpin = $("#btnSpin");
        const kwIn = $("#kw"), chIn = $("#channel"), sumEl = $("#summary");
        const resEl = $("#results"), emptyEl = $("#empty"), player = $("#player");
        const vOverlay = $("#vOverlay"), statusRow = $("#statusRow"), toastEl = $("#toast");
        let activeSearchAbort = null;

        const setBusy = (b) => { btn.disabled = b; btnSpin.style.display = b ? "inline-block" : "none"; btnText.textContent = b ? "Axtarılır..." : "Axtar"; };
        const showToast = (m, e = false) => { toastEl.textContent = m; toastEl.className = "toast show" + (e ? " err" : ""); setTimeout(() => toastEl.className = "toast", 2200); };

        const getToken = () => { const t = localStorage.getItem("auth_token"); return t && t.trim() ? t.trim() : ""; };
        const setToken = (t) => localStorage.setItem("auth_token", (t || "").trim());
        const ensureToken = () => { if (!getToken()) { showToast("Əvvəl token daxil edin və saxlayın.", true); return false; } return true; };

        const authHeaders = () => ({ Authorization: "Bearer " + getToken() });
        const formatTime = (iso) => { try { return new Date(iso).toLocaleTimeString(); } catch { return iso; } };
        const safeEl = (tag, text) => { const el = document.createElement(tag); if (text != null) el.textContent = String(text); return el; };
        const drawStatus = () => { const has = !!getToken(); statusRow.innerHTML = has ? `<span class="pill">Auth: Aktiv</span>` : `<span class="pill" style="background:#2a1a1c;border-color:#5a2b33;color:#ffd7dc">Auth: Passiv</span>`; };
        const nocache = (url) => url + (url.includes("?") ? "&" : "?") + `_t=${Date.now()}`;

        // ---------- UI init ----------
        tokenInput.value = getToken();
        saveBtn.onclick = () => { setToken(tokenInput.value); showToast("Token yadda saxlandı"); drawStatus(); };
        clearBtn.onclick = () => { setToken(""); tokenInput.value = ""; showToast("Token təmizləndi"); drawStatus(); };
        drawStatus();

        kwIn.addEventListener("keydown", (e) => { if (e.key === "Enter") btn.click(); });
        tokenInput.addEventListener("keydown", (e) => { if (e.key === "Enter") saveBtn.click(); });

        // ---------- Search ----------
        btn.addEventListener("click", async () => {
            if (!ensureToken()) return;
            const kw = kwIn.value.trim();
            const channel = chIn.value;
            if (!kw) { showToast("Keyword daxil edin", true); return; }

            if (activeSearchAbort) activeSearchAbort.abort();
            const aborter = new AbortController();
            activeSearchAbort = aborter;

            setBusy(true); resEl.innerHTML = ""; emptyEl.style.display = "none"; sumEl.textContent = "";

            try {
                let url = `/search/?keyword=${encodeURIComponent(kw)}`;
                if (channel) url += `&channel=${encodeURIComponent(channel)}`;

                const sResp = await fetch(url, { headers: authHeaders(), signal: aborter.signal });
                if (!sResp.ok) {
                    const txt = await sResp.text().catch(() => "");
                    throw new Error(`Search ${sResp.status}: ${txt || sResp.statusText}`);
                }
                const items = await sResp.json();
                if (!items?.length) { emptyEl.style.display = "block"; return; }

                for (const seg of items) {
                    const card = document.createElement("div"); card.className = "card";

                    const meta = document.createElement("div"); meta.className = "meta";
                    const pill = safeEl("span", (seg.channel_id || "").toUpperCase()); pill.className = "pill"; meta.appendChild(pill);
                    const spanTime = safeEl("span", `${formatTime(seg.start_time)} • ${(seg.duration_secs || 0).toFixed(1)}s`); spanTime.className = "muted"; meta.appendChild(spanTime);
                    if (seg.score != null) { const s = safeEl("span", `🔥 ${(seg.score * 100).toFixed(0)}%`); s.className = "muted"; meta.appendChild(s); }

                    const p = safeEl("p", seg.text || "");

                    const actions = document.createElement("div"); actions.className = "actions";
                    const playBtn = safeEl("button", "Play"); playBtn.className = "btn play";
                    const sumBtn = safeEl("button", "Xülasə"); sumBtn.className = "btn secondary sum";
                    actions.appendChild(playBtn); actions.appendChild(sumBtn);

                    card.appendChild(meta); card.appendChild(p); card.appendChild(actions);
                    resEl.appendChild(card);

                    // --- PLAY: YALNIZ /video_clip ---
                    playBtn.onclick = async () => {
                        if (!ensureToken()) return;
                        playBtn.disabled = true;

                        try { player.pause(); player.removeAttribute("src"); player.load(); } catch { }

                        const offset = parseFloat(seg.offset_secs || 0);
                        const dur = parseFloat(seg.duration_secs || 0);

                        // min 30s təmin et: default 15s-15s, çatmırsa bərabər böl
                        let pb = 15, pa = 15;
                        const want = pb + dur + pa;
                        if (want < MIN_CLIP_SEC) {
                            const extra = MIN_CLIP_SEC - want; pb += extra / 2; pa += extra / 2;
                        }

                        const start = Math.max(0, offset - pb);
                        const total = dur + pb + pa;

                        // <video> header göndərə bilmir, tokeni query ilə veririk (?access=…)
                        let clipUrl = `/video_clip/?channel=${encodeURIComponent(seg.channel_id)}`
                            + `&video_file=${encodeURIComponent(seg.segment_filename)}`
                            + `&start=${start}&duration=${total}`
                            + `&access=${encodeURIComponent(getToken())}`;
                        clipUrl = nocache(clipUrl);

                        // ---- Qeyd: Köhnə triplet yolu (istək üzrə deaktiv edilib)
                        /*
                        let tripletUrl = `/video_triplet/?channel=${encodeURIComponent(seg.channel_id)}`
                          + `&video_file=${encodeURIComponent(seg.segment_filename)}`
                          + `&offset=${offset}&duration=${dur}&pad_before=${pb}&pad_after=${pa}&fast=1`
                          + `&access=${encodeURIComponent(getToken())}`;
                        tripletUrl = nocache(tripletUrl);
                        console.log("[DISABLED] triplet:", tripletUrl);
                        */

                        console.log("[PLAY] clip:", clipUrl);

                        // overlay aç
                        vOverlay.classList.add("show");

                        const onPlaying = () => {
                            vOverlay.classList.remove("show");
                            playBtn.disabled = false;
                            player.removeEventListener("error", onError);
                        };
                        const onError = (e) => {
                            vOverlay.classList.remove("show");
                            playBtn.disabled = false;
                            console.error("Video error:", e);
                            showToast("Video yüklənmədi", true);
                            player.removeEventListener("playing", onPlaying);
                        };

                        player.addEventListener("playing", onPlaying, { once: true });
                        player.addEventListener("error", onError, { once: true });

                        player.src = clipUrl;
                        await player.play().catch(() => { /* autoplay block ola bilər */ });
                    };

                    // --- SUMMARIZE ---
                    sumBtn.onclick = async () => {
                        if (!ensureToken()) return;
                        sumEl.textContent = "Xülasə əldə edilir…";
                        try {
                            const r2 = await fetch(`/summarize/${seg.id}`, { headers: authHeaders() });
                            if (!r2.ok) {
                                const txt = await r2.text().catch(() => "");
                                throw new Error(`Summarize ${r2.status}: ${txt || r2.statusText}`);
                            }
                            const data = await r2.json();
                            sumEl.textContent = data.summary;
                        } catch {
                            sumEl.textContent = "Xülasə alınmadı";
                        }
                    };
                }
            } catch (e) {
                if (e.name !== "AbortError") showToast(e.message || "Xəta baş verdi", true);
            } finally {
                setBusy(false);
            }
        });
    </script>
</body>

</html>